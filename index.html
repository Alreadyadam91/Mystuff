<script>
    // --- ‚öôÔ∏è CONFIGURATION -------------------------------
    const PROVIDER_MODULE_NAME = "Provider_Numbers";   
    const PROVIDER_NAME_FIELD = "Name";                
    const PROVIDER_CONTACT_FIELD = "Provider_Contact"; 
    // ----------------------------------------------------

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    
    let ZOHO;
    let pdfBytes = null;
    let forms = [];
    let currentPreviewForm = null;
    let currentPreviewPage = 0;
    let pdfDocForPreview = null;
    let selectedContactId = null;
    let selectedContactName = null;
    let availableProviders = [];
    let selectedProviders = [];
    let sdkReady = false;

    // Helper to update the UI status text (so you can see what's happening)
    function setStatus(msg, isError = false) {
        let statusEl = document.getElementById('searchStatus');
        if (!statusEl) {
            statusEl = document.createElement('div');
            statusEl.id = 'searchStatus';
            statusEl.style.fontSize = '0.75rem';
            statusEl.style.marginTop = '4px';
            document.getElementById('doctorSearch').parentNode.appendChild(statusEl);
        }
        statusEl.innerText = msg;
        statusEl.style.color = isError ? '#ef4444' : '#94a3b8'; // Red or Grey
    }

    // Initialize Zoho SDK
    ZOHO.embeddedApp.on("PageLoad", function(data) {
        console.log("‚úÖ Zoho SDK PageLoad");
        sdkReady = true;
        setStatus("System Ready. Type to search.");
    });

    ZOHO.embeddedApp.init().then(() => {
        console.log("‚úÖ Zoho SDK Init");
        sdkReady = true;
    });

    // --- STEP 1: CONTACT SEARCH (BROAD SEARCH MODE) ---
    let searchTimeout;
    document.getElementById('doctorSearch').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        
        if (query.length < 2) {
            document.getElementById('lookupResults').style.display = 'none';
            setStatus("Type at least 2 characters...");
            return;
        }
        
        setStatus("Waiting to stop typing...");
        searchTimeout = setTimeout(() => searchContacts(query), 500);
    });

    async function searchContacts(query) {
        if (!sdkReady) {
            setStatus("‚ö†Ô∏è Zoho SDK is not ready. Try refreshing the page.", true);
            return;
        }

        setStatus(`üîç Searching Zoho for "${query}"...`);
        
        try {
            // "word" search is more forgiving. It searches Name, Email, etc.
            const response = await ZOHO.CRM.API.searchRecord({
                Entity: "Contacts",
                Type: "word",
                Query: query
            });
            
            if (response.data && response.data.length > 0) {
                setStatus(`‚úÖ Found ${response.data.length} contacts.`);
                displayLookupResults(response.data);
            } else {
                setStatus("‚ùå No contacts found.", true);
                document.getElementById('lookupResults').innerHTML = '<div class="lookup-item">No matches found</div>';
                document.getElementById('lookupResults').style.display = 'block';
            }
        } catch (error) {
            console.error(error);
            setStatus(`‚ùå Error: ${error.message || "Check Console"}`, true);
        }
    }

    function displayLookupResults(contacts) {
        const resultsDiv = document.getElementById('lookupResults');
        resultsDiv.innerHTML = '';
        
        // Limit to 10 results
        contacts.slice(0, 10).forEach(contact => {
            const div = document.createElement('div');
            div.className = 'lookup-item';
            
            // Construct Name safely
            const fullName = contact.Full_Name || `${contact.First_Name || ''} ${contact.Last_Name || ''}`.trim() || "Unknown Name";
            
            div.innerHTML = `
                <div style="font-weight:600;">${fullName}</div>
                <div style="font-size:0.85rem; color:var(--text-dim);">${contact.Email || 'No Email'}</div>
            `;
            div.onclick = () => selectContact(contact, fullName);
            resultsDiv.appendChild(div);
        });
        
        resultsDiv.style.display = 'block';
    }

    async function selectContact(contact, fullName) {
        selectedContactId = contact.id;
        selectedContactName = fullName;
        
        document.getElementById('doctorSearch').value = fullName;
        document.getElementById('selectedContactId').value = contact.id;
        document.getElementById('lookupResults').style.display = 'none';
        setStatus(`‚úÖ Selected: ${fullName}`);
        
        // Trigger Provider Search using the Contact ID
        await fetchProviderNumbers(contact.id);
    }

    // --- STEP 2: FETCH PROVIDERS FROM CUSTOM MODULE ---
    async function fetchProviderNumbers(contactId) {
        setStatus("üîç Finding Provider Numbers...");
        
        try {
            const response = await ZOHO.CRM.API.searchRecord({
                Entity: PROVIDER_MODULE_NAME,
                Type: "criteria",
                Query: `(${PROVIDER_CONTACT_FIELD}:equals:${contactId})`
            });
            
            availableProviders = [];

            if (response.data) {
                setStatus(`‚úÖ Found ${response.data.length} provider numbers.`);
                response.data.forEach(record => {
                    // Try 'Name' first, then 'Provider_Number'
                    const pNum = record[PROVIDER_NAME_FIELD] || record.Provider_Number;
                    
                    // Logic to find label
                    let pLoc = "";
                    if (record.Hospital && record.Hospital.name) {
                        pLoc = record.Hospital.name; 
                    } else if (record.Practice_Name) {
                        pLoc = record.Practice_Name;
                    }
                    
                    if(pNum) {
                        availableProviders.push({
                            value: pNum,
                            label: pLoc ? `${pNum} (${pLoc})` : pNum
                        });
                    }
                });
                
                displayProviderCheckboxes();
            } else {
                setStatus("‚ö†Ô∏è No provider numbers found for this contact.", true);
                document.getElementById('providerGroup').style.display = 'none';
            }
        } catch (error) {
            console.error("Provider Error:", error);
            setStatus(`‚ùå Provider Error: ${error.message}`, true);
        }
    }

    function displayProviderCheckboxes() {
        const container = document.getElementById('providerCheckboxes');
        container.innerHTML = '';
        
        if(availableProviders.length === 0) return;

        availableProviders.forEach((providerObj) => {
            const label = document.createElement('label');
            label.className = 'checkbox-label';
            label.innerHTML = `
                <input type="checkbox" value="${providerObj.value}" onchange="updateSelectedProviders()">
                <span>${providerObj.label}</span>
            `;
            container.appendChild(label);
        });
        
        document.getElementById('providerGroup').style.display = 'block';
    }

    function updateSelectedProviders() {
        const checkboxes = document.querySelectorAll('#providerCheckboxes input[type="checkbox"]:checked');
        selectedProviders = Array.from(checkboxes).map(cb => cb.value);
        
        const display = document.getElementById('selectedProviders');
        display.innerHTML = selectedProviders.map(p => 
            `<span class="selected-provider">${p}</span>`
        ).join('');
    }

    // --- STEP 3: PDF PROCESSING (Unchanged) ---
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        if(!selectedContactId) {
            alert("Please select a contact first");
            return;
        }

        if(selectedProviders.length === 0) {
            alert("Please select at least one provider number");
            return;
        }

        document.getElementById('step1').style.display = 'none';
        document.getElementById('debugBox').style.display = 'block';
        setStatus("Processing PDF...");
        
        try {
            updateDebug("Loading PDF File...", null);
            pdfBytes = await file.arrayBuffer();
            
            const pdf = await pdfjsLib.getDocument({ data: pdfBytes.slice(0) }).promise;
            updateDebug(`PDF Loaded. Scanning ${pdf.numPages} pages...`, null);

            forms = [];
            let currentForm = null;

            for(let i=1; i<=pdf.numPages; i++) {
                updateDebug(`Scanning Page ${i}/${pdf.numPages}...`, null);
                
                const page = await pdf.getPage(i);
                const scale = 3.0; 
                const viewport = page.getViewport({ scale: scale });

                const scanX = Math.floor(viewport.width * 0.6);
                const scanY = Math.floor(viewport.height * 0.6);
                const scanW = Math.floor(viewport.width * 0.4);
                const scanH = Math.floor(viewport.height * 0.4);

                const canvas = document.createElement('canvas');
                canvas.width = scanW;
                canvas.height = scanH;
                const ctx = canvas.getContext('2d');
                ctx.translate(-scanX, -scanY);
                
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                if (i === 1) {
                    const debugCanvas = document.getElementById('debugCanvas');
                    debugCanvas.width = scanW;
                    debugCanvas.height = scanH;
                    debugCanvas.getContext('2d').putImageData(ctx.getImageData(0,0,scanW,scanH), 0, 0);
                }

                const imageData = ctx.getImageData(0, 0, scanW, scanH);
                const code = jsQR(imageData.data, scanW, scanH, { inversionAttempts: "dontInvert" });

                if (code && code.data) {
                    let name = code.data;
                    if(name.includes('http')) { try { name = name.split('/').pop(); } catch(e){} }
                    name = name.replace(/[^a-zA-Z0-9 \-_]/g, '').substring(0, 30);
                    
                    if(currentForm) forms.push(currentForm);
                    updateDebug(`Page ${i}: QR Found! (${name})`, true);
                    currentForm = { name: name || `Form_${forms.length+1}`, pages: [i] };
                } else {
                    if(currentForm) { currentForm.pages.push(i); } 
                    else { currentForm = { name: "Manual_Review_Or_Header", pages: [i] }; }
                }
            }
            if(currentForm) forms.push(currentForm);

            pdfDocForPreview = pdf;
            renderResults();

        } catch(err) {
            alert("Error: " + err.message);
            updateDebug("Error: " + err.message);
            console.error(err);
        }
    });

    function updateDebug(msg, success) {
        const el = document.getElementById('scanStatus');
        el.innerText = msg;
        if(success === true) el.style.color = '#4ade80';
        else if(success === false) el.style.color = '#fbbf24';
        else el.style.color = 'white';
    }

    function renderResults() {
        document.getElementById('debugBox').style.display = 'none';
        document.getElementById('step2').classList.remove('hidden');
        const list = document.getElementById('resultsList');
        list.innerHTML = '';

        forms.forEach((f, idx) => {
            const div = document.createElement('div');
            div.className = 'form-row'; 
            div.onclick = () => openPreview(idx);
            div.innerHTML = `
                <div class="form-icon">${idx+1}</div>
                <div style="flex:1">
                    <input type="text" value="${f.name}" id="name-${idx}" onclick="event.stopPropagation()" style="width:100%; border:none; background:transparent; font-weight:bold; outline:none; font-size:1rem; color:var(--text);">
                    <div style="font-size:0.85rem; color:var(--text-dim); margin-top:4px;">Pages ${f.pages.join(', ')} ‚Ä¢ ${f.pages.length} page${f.pages.length>1?'s':''} ‚Ä¢ Click to preview</div>
                </div>`;
            list.appendChild(div);
        });
    }

    async function openPreview(formIdx) {
        currentPreviewForm = forms[formIdx];
        currentPreviewPage = 0;
        document.getElementById('previewModal').classList.add('active');
        await renderPreviewPage();
    }

    function closePreview() {
        document.getElementById('previewModal').classList.remove('active');
        currentPreviewForm = null;
    }

    async function previewPrevPage() {
        if (currentPreviewPage > 0) { currentPreviewPage--; await renderPreviewPage(); }
    }

    async function previewNextPage() {
        if (currentPreviewPage < currentPreviewForm.pages.length - 1) { currentPreviewPage++; await renderPreviewPage(); }
    }

    async function renderPreviewPage() {
        const pageNum = currentPreviewForm.pages[currentPreviewPage];
        document.getElementById('previewTitle').innerText = `Preview: ${currentPreviewForm.name}`;
        document.getElementById('previewInfo').innerText = `Viewing page ${currentPreviewPage + 1} of ${currentPreviewForm.pages.length} (PDF page ${pageNum})`;
        document.getElementById('pageIndicator').innerText = `${currentPreviewPage + 1} / ${currentPreviewForm.pages.length}`;
        document.getElementById('prevPageBtn').disabled = currentPreviewPage === 0;
        document.getElementById('nextPageBtn').disabled = currentPreviewPage === currentPreviewForm.pages.length - 1;

        const page = await pdfDocForPreview.getPage(pageNum);
        const scale = 1.5;
        const viewport = page.getViewport({ scale });
        const canvas = document.getElementById('previewCanvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const ctx = canvas.getContext('2d');
        await page.render({ canvasContext: ctx, viewport }).promise;
    }

    async function uploadToZoho() {
        const btn = document.getElementById('uploadBtn');
        btn.innerText = "‚è≥ Uploading to Zoho CRM...";
        btn.disabled = true;
        
        const srcDoc = await PDFLib.PDFDocument.load(pdfBytes);

        for (let idx = 0; idx < forms.length; idx++) {
            const f = forms[idx];
            const finalName = document.getElementById(`name-${idx}`).value;
            const newDoc = await PDFLib.PDFDocument.create();
            const indices = f.pages.map(p => p - 1);
            const copied = await newDoc.copyPages(srcDoc, indices);
            copied.forEach(p => newDoc.addPage(p));
            
            const bytes = await newDoc.save();
            const base64 = await arrayBufferToBase64(bytes);
            
            // Clean filename
            const fileName = `Dr_${selectedContactName.replace(/[^a-zA-Z0-9]/g, '_')}_${finalName.replace(/ /g, '_')}.pdf`;
            
            try {
                // Upload as attachment to CONTACT
                await ZOHO.CRM.API.attachFile({
                    Entity: "Contacts",
                    RecordID: selectedContactId,
                    File: {
                        Name: fileName,
                        Content: base64
                    }
                });
                
                updateDebug(`Uploaded: ${fileName}`, true);
            } catch (error) {
                console.error("Error uploading file:", error);
                alert(`Failed to upload ${fileName}: ${error.message}`);
            }
            
            await new Promise(r => setTimeout(r, 500));
        }
        
        btn.innerText = "‚úÖ All Files Uploaded!";
        setTimeout(() => { 
            btn.disabled = false; 
            btn.innerText = "‚òÅÔ∏è Upload All to Zoho CRM Contact"; 
        }, 3000);
    }

    function arrayBufferToBase64(buffer) {
        return new Promise((resolve) => {
            const blob = new Blob([buffer], { type: 'application/pdf' });
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.readAsDataURL(blob);
        });
    }

    // Close lookup on outside click
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#doctorSearch') && !e.target.closest('#lookupResults')) {
            document.getElementById('lookupResults').style.display = 'none';
        }
    });
</script>
