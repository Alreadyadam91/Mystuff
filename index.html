<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Fund Pack Separator - Zoho CRM</title>
    
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <script src="pdf.min.js"></script>
    <script src="jsQR.min.js"></script>
    <script src="pdf-lib.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        :root { --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --accent: #667eea; --accent-light: #818cf8; --bg: #0f172a; --card: #1e293b; --border: #334155; --text: #e2e8f0; --text-dim: #94a3b8; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .app { max-width: 1000px; margin: 0 auto; background: var(--card); border-radius: 20px; overflow: hidden; border: 1px solid var(--border); }
        .header { background: var(--primary); padding: 30px 40px; display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; }
        .header h1 { margin: 0; font-size: 1.8rem; font-weight: 800; color: white; position: relative; z-index: 1; }
        .header-subtitle { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; font-weight: 500; }
        .btn-reset { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; z-index: 1; position: relative; }
        .content { padding: 40px; }
        .input-group { margin-bottom: 25px; position: relative; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text); }
        input, textarea, select { width: 100%; padding: 14px 18px; border: 2px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); font-size: 1rem; }
        .lookup-input { cursor: pointer; }
        .lookup-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--card); border: 2px solid var(--accent); border-radius: 12px; max-height: 300px; overflow-y: auto; z-index: 100; display: none; margin-top: 5px; }
        .lookup-item { padding: 12px 18px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .lookup-item:hover { background: var(--bg); }
        .lookup-item:last-child { border-bottom: none; }
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; max-height: 200px; overflow-y: auto; padding: 10px; background: var(--bg); border-radius: 8px; }
        .checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 8px; border-radius: 6px; }
        .checkbox-label:hover { background: var(--card); }
        .checkbox-label input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .upload-zone { border: 3px dashed var(--border); border-radius: 16px; padding: 60px 40px; text-align: center; cursor: pointer; background: rgba(102, 126, 234, 0.05); transition: all 0.4s ease; }
        .upload-zone:hover { border-color: var(--accent); background: rgba(102, 126, 234, 0.1); }
        .debug-container { margin-top: 30px; padding: 25px; background: #1e293b; border-radius: 16px; color: white; display: none; border: 1px solid var(--border); }
        .debug-canvas { border: 2px solid var(--accent); margin-top: 15px; max-width: 100%; height: auto; border-radius: 8px; }
        .form-row { display: flex; align-items: center; padding: 18px 20px; border: 2px solid var(--border); border-radius: 14px; margin-bottom: 12px; background: var(--bg); cursor: pointer; }
        .form-icon { width: 48px; height: 48px; background: var(--primary); color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 16px; font-weight: 800; }
        .preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .preview-modal.active { display: flex; }
        .preview-content { background: var(--card); border-radius: 20px; padding: 30px; max-width: 95%; max-height: 95%; overflow: auto; position: relative; border: 1px solid var(--border); }
        .preview-close { position: absolute; top: 20px; right: 20px; background: #ef4444; color: white; border: none; border-radius: 10px; padding: 10px 20px; cursor: pointer; }
        .preview-canvas { border: 2px solid var(--border); margin-top: 20px; max-width: 100%; border-radius: 12px; }
        .preview-nav { display: flex; gap: 15px; margin-top: 20px; justify-content: center; align-items: center; }
        .btn { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 25px; font-size: 1.1rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .hidden { display: none; }
        .selected-provider { display: inline-block; background: var(--accent); color: white; padding: 6px 12px; border-radius: 6px; margin: 5px 5px 0 0; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="app">
    <div class="header">
        <div>
            <h1>Health Fund Pack Separator</h1>
            <div class="header-subtitle">Zoho CRM Integrated ‚Ä¢ QR Detection & Document Splitting</div>
        </div>
        <button class="btn-reset" onclick="location.reload()">‚Üª Reset</button>
    </div>
    <div class="content">
        <div id="step1">
            <div class="input-group">
                <label>üë®‚Äç‚öïÔ∏è Doctor Name (Search Contact)</label>
                <input type="text" id="doctorSearch" class="lookup-input" placeholder="Type to search contacts..." autocomplete="off">
                <input type="hidden" id="selectedContactId">
                <div id="lookupResults" class="lookup-results"></div>
            </div>
            
            <div class="input-group" id="providerGroup" style="display:none;">
                <label>üî¢ Select Provider Number(s)</label>
                <div id="providerCheckboxes" class="checkbox-group"></div>
                <div id="selectedProviders"></div>
            </div>
            
            <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                <h3>üì§ Upload PDF Pack</h3>
                <p style="color:var(--text-dim); margin-top:8px;">Scanning bottom-right corner of every page for QR codes</p>
                <input type="file" id="fileInput" accept="application/pdf" style="display:none">
            </div>
        </div>
        
        <div id="debugBox" class="debug-container">
            <div class="debug-info">üîç SCANNER DEBUG VIEW (Bottom Right Corner)</div>
            <div id="scanStatus">Initializing...</div>
            <canvas id="debugCanvas" class="debug-canvas"></canvas>
            <div style="font-size:0.8rem; color:var(--text-dim); margin-top:8px;">If you see the QR code clearly above, detection will work perfectly.</div>
        </div>
        
        <div id="step2" class="hidden">
            <h3 style="margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid var(--border); font-size:1.4rem;">‚úÖ Detected Forms (Click to Preview)</h3>
            <div id="resultsList"></div>
            <button id="uploadBtn" class="btn" onclick="uploadToZoho()">‚òÅÔ∏è Upload All to Zoho CRM Contact</button>
        </div>
    </div>
</div>

<div id="previewModal" class="preview-modal">
    <div class="preview-content">
        <button class="preview-close" onclick="closePreview()">‚úï Close</button>
        <h3 id="previewTitle" style="font-size:1.5rem;">Preview</h3>
        <div style="color: var(--text-dim); margin-top: 8px;" id="previewInfo"></div>
        <canvas id="previewCanvas" class="preview-canvas"></canvas>
        <div class="preview-nav">
            <button onclick="previewPrevPage()" id="prevPageBtn">‚Üê Previous</button>
            <span id="pageIndicator" style="padding: 12px 20px; color: var(--text-dim); font-weight:600;"></span>
            <button onclick="previewNextPage()" id="nextPageBtn">Next ‚Üí</button>
        </div>
    </div>
</div>

<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.min.js';
    
    let ZOHO;
    let pdfBytes = null;
    let forms = [];
    let currentPreviewForm = null;
    let currentPreviewPage = 0;
    let pdfDocForPreview = null;
    let selectedContactId = null;
    let selectedContactName = null;
    let availableProviders = [];
    let selectedProviders = [];

    // Initialize Zoho SDK
    ZOHO.embeddedApp.on("PageLoad", function(data) {
        console.log("Zoho SDK initialized");
    });

    ZOHO.embeddedApp.init();

    // Contact Search with Debounce
    let searchTimeout;
    document.getElementById('doctorSearch').addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.trim();
        
        if (query.length < 2) {
            document.getElementById('lookupResults').style.display = 'none';
            return;
        }
        
        searchTimeout = setTimeout(() => searchContacts(query), 300);
    });

    async function searchContacts(query) {
        try {
            const response = await ZOHO.CRM.API.searchRecord({
                Entity: "Contacts",
                Type: "criteria",
                Query: `(Full_Name:starts_with:${query})`
            });
            
            if (response.data) {
                displayLookupResults(response.data);
            }
        } catch (error) {
            console.error("Error searching contacts:", error);
        }
    }

    function displayLookupResults(contacts) {
        const resultsDiv = document.getElementById('lookupResults');
        resultsDiv.innerHTML = '';
        
        if (contacts.length === 0) {
            resultsDiv.innerHTML = '<div class="lookup-item">No contacts found</div>';
            resultsDiv.style.display = 'block';
            return;
        }
        
        contacts.forEach(contact => {
            const div = document.createElement('div');
            div.className = 'lookup-item';
            div.innerHTML = `
                <div style="font-weight:600;">${contact.Full_Name}</div>
                <div style="font-size:0.85rem; color:var(--text-dim);">${contact.Email || ''}</div>
            `;
            div.onclick = () => selectContact(contact);
            resultsDiv.appendChild(div);
        });
        
        resultsDiv.style.display = 'block';
    }

    async function selectContact(contact) {
        selectedContactId = contact.id;
        selectedContactName = contact.Full_Name;
        document.getElementById('doctorSearch').value = contact.Full_Name;
        document.getElementById('selectedContactId').value = contact.id;
        document.getElementById('lookupResults').style.display = 'none';
        
        // Fetch provider numbers for this contact
        await fetchProviderNumbers(contact.id);
    }

    async function fetchProviderNumbers(contactId) {
        try {
            // Fetch the contact record to get provider numbers
            const response = await ZOHO.CRM.API.getRecord({
                Entity: "Contacts",
                RecordID: contactId
            });
            
            if (response.data && response.data[0]) {
                const contact = response.data[0];
                
                // Assuming provider numbers are stored in a multi-select field called "Provider_Numbers"
                // Adjust field name based on your CRM setup
                const providerField = contact.Provider_Numbers || contact.Provider_Number || '';
                
                if (providerField) {
                    availableProviders = providerField.split(';').map(p => p.trim()).filter(p => p);
                    displayProviderCheckboxes();
                } else {
                    alert("No provider numbers found for this contact");
                }
            }
        } catch (error) {
            console.error("Error fetching provider numbers:", error);
            alert("Could not fetch provider numbers. Please check field configuration.");
        }
    }

    function displayProviderCheckboxes() {
        const container = document.getElementById('providerCheckboxes');
        container.innerHTML = '';
        
        availableProviders.forEach((provider, index) => {
            const label = document.createElement('label');
            label.className = 'checkbox-label';
            label.innerHTML = `
                <input type="checkbox" value="${provider}" onchange="updateSelectedProviders()">
                <span>${provider}</span>
            `;
            container.appendChild(label);
        });
        
        document.getElementById('providerGroup').style.display = 'block';
    }

    function updateSelectedProviders() {
        const checkboxes = document.querySelectorAll('#providerCheckboxes input[type="checkbox"]:checked');
        selectedProviders = Array.from(checkboxes).map(cb => cb.value);
        
        const display = document.getElementById('selectedProviders');
        display.innerHTML = selectedProviders.map(p => 
            `<span class="selected-provider">${p}</span>`
        ).join('');
    }

    // PDF Processing (keeping existing logic)
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        if(!selectedContactId) {
            alert("Please select a contact first");
            return;
        }

        if(selectedProviders.length === 0) {
            alert("Please select at least one provider number");
            return;
        }

        document.getElementById('step1').style.display = 'none';
        document.getElementById('debugBox').style.display = 'block';
        
        try {
            updateDebug("Loading PDF File...", null);
            pdfBytes = await file.arrayBuffer();
            
            const pdf = await pdfjsLib.getDocument({ data: pdfBytes.slice(0) }).promise;
            updateDebug(`PDF Loaded. Scanning ${pdf.numPages} pages...`, null);

            forms = [];
            let currentForm = null;

            for(let i=1; i<=pdf.numPages; i++) {
                updateDebug(`Scanning Page ${i}/${pdf.numPages}...`, null);
                
                const page = await pdf.getPage(i);
                const scale = 3.0; 
                const viewport = page.getViewport({ scale: scale });

                const scanX = Math.floor(viewport.width * 0.6);
                const scanY = Math.floor(viewport.height * 0.6);
                const scanW = Math.floor(viewport.width * 0.4);
                const scanH = Math.floor(viewport.height * 0.4);

                const canvas = document.createElement('canvas');
                canvas.width = scanW;
                canvas.height = scanH;
                const ctx = canvas.getContext('2d');
                ctx.translate(-scanX, -scanY);
                
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                if (i === 1) {
                    const debugCanvas = document.getElementById('debugCanvas');
                    debugCanvas.width = scanW;
                    debugCanvas.height = scanH;
                    debugCanvas.getContext('2d').putImageData(ctx.getImageData(0,0,scanW,scanH), 0, 0);
                }

                const imageData = ctx.getImageData(0, 0, scanW, scanH);
                const code = jsQR(imageData.data, scanW, scanH, { inversionAttempts: "dontInvert" });

                if (code && code.data) {
                    let name = code.data;
                    if(name.includes('http')) { try { name = name.split('/').pop(); } catch(e){} }
                    name = name.replace(/[^a-zA-Z0-9 \-_]/g, '').substring(0, 30);
                    
                    if(currentForm) forms.push(currentForm);
                    updateDebug(`Page ${i}: QR Found! (${name})`, true);
                    currentForm = { name: name || `Form_${forms.length+1}`, pages: [i] };
                } else {
                    if(currentForm) { currentForm.pages.push(i); } 
                    else { currentForm = { name: "Manual_Review_Or_Header", pages: [i] }; }
                }
            }
            if(currentForm) forms.push(currentForm);

            pdfDocForPreview = pdf;
            renderResults();

        } catch(err) {
            alert("Error: " + err.message);
            updateDebug("Error: " + err.message);
            console.error(err);
        }
    });

    function updateDebug(msg, success) {
        const el = document.getElementById('scanStatus');
        el.innerText = msg;
        if(success === true) el.style.color = '#4ade80';
        else if(success === false) el.style.color = '#fbbf24';
        else el.style.color = 'white';
    }

    function renderResults() {
        document.getElementById('debugBox').style.display = 'none';
        document.getElementById('step2').classList.remove('hidden');
        const list = document.getElementById('resultsList');
        list.innerHTML = '';

        forms.forEach((f, idx) => {
            const div = document.createElement('div');
            div.className = 'form-row'; 
            div.onclick = () => openPreview(idx);
            div.innerHTML = `
                <div class="form-icon">${idx+1}</div>
                <div style="flex:1">
                    <input type="text" value="${f.name}" id="name-${idx}" onclick="event.stopPropagation()" style="width:100%; border:none; background:transparent; font-weight:bold; outline:none; font-size:1rem; color:var(--text);">
                    <div style="font-size:0.85rem; color:var(--text-dim); margin-top:4px;">Pages ${f.pages.join(', ')} ‚Ä¢ ${f.pages.length} page${f.pages.length>1?'s':''} ‚Ä¢ Click to preview</div>
                </div>`;
            list.appendChild(div);
        });
    }

    async function openPreview(formIdx) {
        currentPreviewForm = forms[formIdx];
        currentPreviewPage = 0;
        document.getElementById('previewModal').classList.add('active');
        await renderPreviewPage();
    }

    function closePreview() {
        document.getElementById('previewModal').classList.remove('active');
        currentPreviewForm = null;
    }

    async function previewPrevPage() {
        if (currentPreviewPage > 0) { currentPreviewPage--; await renderPreviewPage(); }
    }

    async function previewNextPage() {
        if (currentPreviewPage < currentPreviewForm.pages.length - 1) { currentPreviewPage++; await renderPreviewPage(); }
    }

    async function renderPreviewPage() {
        const pageNum = currentPreviewForm.pages[currentPreviewPage];
        document.getElementById('previewTitle').innerText = `Preview: ${currentPreviewForm.name}`;
        document.getElementById('previewInfo').innerText = `Viewing page ${currentPreviewPage + 1} of ${currentPreviewForm.pages.length} (PDF page ${pageNum})`;
        document.getElementById('pageIndicator').innerText = `${currentPreviewPage + 1} / ${currentPreviewForm.pages.length}`;
        document.getElementById('prevPageBtn').disabled = currentPreviewPage === 0;
        document.getElementById('nextPageBtn').disabled = currentPreviewPage === currentPreviewForm.pages.length - 1;

        const page = await pdfDocForPreview.getPage(pageNum);
        const scale = 1.5;
        const viewport = page.getViewport({ scale });
        const canvas = document.getElementById('previewCanvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const ctx = canvas.getContext('2d');
        await page.render({ canvasContext: ctx, viewport }).promise;
    }

    async function uploadToZoho() {
        const btn = document.getElementById('uploadBtn');
        btn.innerText = "‚è≥ Uploading to Zoho CRM...";
        btn.disabled = true;
        
        const srcDoc = await PDFLib.PDFDocument.load(pdfBytes);

        for (let idx = 0; idx < forms.length; idx++) {
            const f = forms[idx];
            const finalName = document.getElementById(`name-${idx}`).value;
            const newDoc = await PDFLib.PDFDocument.create();
            const indices = f.pages.map(p => p - 1);
            const copied = await newDoc.copyPages(srcDoc, indices);
            copied.forEach(p => newDoc.addPage(p));
            
            const bytes = await newDoc.save();
            const base64 = await arrayBufferToBase64(bytes);
            
            const fileName = `Dr_${selectedContactName.replace(/[^a-zA-Z0-9]/g, '_')}_${finalName.replace(/ /g, '_')}.pdf`;
            
            try {
                // Upload as attachment to contact
                await ZOHO.CRM.API.attachFile({
                    Entity: "Contacts",
                    RecordID: selectedContactId,
                    File: {
                        Name: fileName,
                        Content: base64
                    }
                });
                
                updateDebug(`Uploaded: ${fileName}`, true);
            } catch (error) {
                console.error("Error uploading file:", error);
                alert(`Failed to upload ${fileName}: ${error.message}`);
            }
            
            await new Promise(r => setTimeout(r, 500));
        }
        
        btn.innerText = "‚úÖ All Files Uploaded!";
        setTimeout(() => { 
            btn.disabled = false; 
            btn.innerText = "‚òÅÔ∏è Upload All to Zoho CRM Contact"; 
        }, 3000);
    }

    function arrayBufferToBase64(buffer) {
        return new Promise((resolve) => {
            const blob = new Blob([buffer], { type: 'application/pdf' });
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.readAsDataURL(blob);
        });
    }

    // Close lookup on outside click
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#doctorSearch') && !e.target.closest('#lookupResults')) {
            document.getElementById('lookupResults').style.display = 'none';
        }
    });
</script>
</body>
</html>
