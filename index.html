<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adam's Health Fund Pack Separator</title>
    
    <script src="pdf.min.js"></script>
    <script src="jsQR.min.js"></script>
    <script src="pdf-lib.min.js"></script>

    <style>
        /* (Styles kept identical to previous version) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        :root { --primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --accent: #667eea; --accent-light: #818cf8; --bg: #0f172a; --card: #1e293b; --border: #334155; --text: #e2e8f0; --text-dim: #94a3b8; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .app { max-width: 1000px; margin: 0 auto; background: var(--card); border-radius: 20px; overflow: hidden; border: 1px solid var(--border); }
        .header { background: var(--primary); padding: 30px 40px; display: flex; justify-content: space-between; align-items: center; position: relative; overflow: hidden; }
        .header h1 { margin: 0; font-size: 1.8rem; font-weight: 800; color: white; position: relative; z-index: 1; }
        .header-subtitle { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; font-weight: 500; }
        .btn-reset { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; z-index: 1; position: relative; }
        .content { padding: 40px; }
        .input-group { margin-bottom: 25px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text); }
        input, textarea { width: 100%; padding: 14px 18px; border: 2px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); font-size: 1rem; }
        .upload-zone { border: 3px dashed var(--border); border-radius: 16px; padding: 60px 40px; text-align: center; cursor: pointer; background: rgba(102, 126, 234, 0.05); transition: all 0.4s ease; }
        .upload-zone:hover { border-color: var(--accent); background: rgba(102, 126, 234, 0.1); }
        .debug-container { margin-top: 30px; padding: 25px; background: #1e293b; border-radius: 16px; color: white; display: none; border: 1px solid var(--border); }
        .debug-canvas { border: 2px solid var(--accent); margin-top: 15px; max-width: 100%; height: auto; border-radius: 8px; }
        .form-row { display: flex; align-items: center; padding: 18px 20px; border: 2px solid var(--border); border-radius: 14px; margin-bottom: 12px; background: var(--bg); cursor: pointer; }
        .form-icon { width: 48px; height: 48px; background: var(--primary); color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 16px; font-weight: 800; }
        .preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .preview-modal.active { display: flex; }
        .preview-content { background: var(--card); border-radius: 20px; padding: 30px; max-width: 95%; max-height: 95%; overflow: auto; position: relative; border: 1px solid var(--border); }
        .preview-close { position: absolute; top: 20px; right: 20px; background: #ef4444; color: white; border: none; border-radius: 10px; padding: 10px 20px; cursor: pointer; }
        .preview-canvas { border: 2px solid var(--border); margin-top: 20px; max-width: 100%; border-radius: 12px; }
        .preview-nav { display: flex; gap: 15px; margin-top: 20px; justify-content: center; align-items: center; }
        .btn { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 25px; font-size: 1.1rem; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="app">
    <div class="header">
        <div>
            <h1>Adam's Health Fund Pack Separator</h1>
            <div class="header-subtitle">Intelligent QR Code Detection & Document Splitting</div>
        </div>
        <button class="btn-reset" onclick="location.reload()">‚Üª Reset</button>
    </div>
    <div class="content">
        <div id="step1">
            <div class="input-group">
                <label>üë®‚Äç‚öïÔ∏è Doctor Name</label>
                <input type="text" id="doctorName" placeholder="e.g. Dr. John Smith">
            </div>
            <div class="input-group">
                <label>üî¢ Provider Number(s)</label>
                <textarea id="providerNumbers" rows="1" placeholder="e.g. 1234567A"></textarea>
            </div>
            <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                <h3>üì§ Upload PDF Pack</h3>
                <p style="color:var(--text-dim); margin-top:8px;">Scanning bottom-right corner of every page for QR codes</p>
                <input type="file" id="fileInput" accept="application/pdf" style="display:none">
            </div>
        </div>
        
        <div id="debugBox" class="debug-container">
            <div class="debug-info">üîç SCANNER DEBUG VIEW (Bottom Right Corner)</div>
            <div id="scanStatus">Initializing...</div>
            <canvas id="debugCanvas" class="debug-canvas"></canvas>
            <div style="font-size:0.8rem; color:var(--text-dim); margin-top:8px;">If you see the QR code clearly above, detection will work perfectly.</div>
        </div>
        
        <div id="step2" class="hidden">
            <h3 style="margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid var(--border); font-size:1.4rem;">‚úÖ Detected Forms (Click to Preview)</h3>
            <div id="resultsList"></div>
            <button id="downloadBtn" class="btn" onclick="processDownloads()">‚¨áÔ∏è Download All Separated Files</button>
        </div>
    </div>
</div>

<div id="previewModal" class="preview-modal">
    <div class="preview-content">
        <button class="preview-close" onclick="closePreview()">‚úï Close</button>
        <h3 id="previewTitle" style="font-size:1.5rem;">Preview</h3>
        <div style="color: var(--text-dim); margin-top: 8px;" id="previewInfo"></div>
        <canvas id="previewCanvas" class="preview-canvas"></canvas>
        <div class="preview-nav">
            <button onclick="previewPrevPage()" id="prevPageBtn">‚Üê Previous</button>
            <span id="pageIndicator" style="padding: 12px 20px; color: var(--text-dim); font-weight:600;"></span>
            <button onclick="previewNextPage()" id="nextPageBtn">Next ‚Üí</button>
        </div>
    </div>
</div>

<script>
    // CRITICAL FIX: Point to the LOCAL worker file we downloaded
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'pdf.worker.min.js';
    
    let pdfBytes = null;
    let forms = [];
    let currentPreviewForm = null;
    let currentPreviewPage = 0;
    let pdfDocForPreview = null;

    window.onload = function() {
        if (typeof pdfjsLib === 'undefined' || typeof jsQR === 'undefined' || typeof PDFLib === 'undefined') {
            alert("Error: One or more library files (pdf.min.js, jsQR.min.js, etc.) are missing from the zip file.");
        }
    };

    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        const docName = document.getElementById('doctorName').value;
        if(!docName) {
            alert("Please enter Doctor Name first");
            return;
        }

        document.getElementById('step1').style.display = 'none';
        document.getElementById('debugBox').style.display = 'block';
        
        try {
            updateDebug("Loading PDF File...", null);
            pdfBytes = await file.arrayBuffer();
            
            const pdf = await pdfjsLib.getDocument({ data: pdfBytes.slice(0) }).promise;
            updateDebug(`PDF Loaded. Scanning ${pdf.numPages} pages...`, null);

            forms = [];
            let currentForm = null;

            for(let i=1; i<=pdf.numPages; i++) {
                updateDebug(`Scanning Page ${i}/${pdf.numPages}...`, null);
                
                const page = await pdf.getPage(i);
                
                // --- SCANNING CONFIGURATION ---
                const scale = 3.0; 
                const viewport = page.getViewport({ scale: scale });

                const scanX = Math.floor(viewport.width * 0.6);
                const scanY = Math.floor(viewport.height * 0.6);
                const scanW = Math.floor(viewport.width * 0.4);
                const scanH = Math.floor(viewport.height * 0.4);

                const canvas = document.createElement('canvas');
                canvas.width = scanW;
                canvas.height = scanH;
                const ctx = canvas.getContext('2d');
                ctx.translate(-scanX, -scanY);
                
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                if (i === 1) {
                    const debugCanvas = document.getElementById('debugCanvas');
                    debugCanvas.width = scanW;
                    debugCanvas.height = scanH;
                    debugCanvas.getContext('2d').putImageData(ctx.getImageData(0,0,scanW,scanH), 0, 0);
                }

                const imageData = ctx.getImageData(0, 0, scanW, scanH);
                const code = jsQR(imageData.data, scanW, scanH, { inversionAttempts: "dontInvert" });

                if (code && code.data) {
                    let name = code.data;
                    if(name.includes('http')) { try { name = name.split('/').pop(); } catch(e){} }
                    name = name.replace(/[^a-zA-Z0-9 \-_]/g, '').substring(0, 30);
                    
                    if(currentForm) forms.push(currentForm);
                    updateDebug(`Page ${i}: QR Found! (${name})`, true);
                    currentForm = { name: name || `Form_${forms.length+1}`, pages: [i] };
                } else {
                    if(currentForm) { currentForm.pages.push(i); } 
                    else { currentForm = { name: "Manual_Review_Or_Header", pages: [i] }; }
                }
            }
            if(currentForm) forms.push(currentForm);

            pdfDocForPreview = pdf;
            renderResults();

        } catch(err) {
            alert("Error: " + err.message);
            updateDebug("Error: " + err.message);
            console.error(err);
        }
    });

    function updateDebug(msg, success) {
        const el = document.getElementById('scanStatus');
        el.innerText = msg;
        if(success === true) el.style.color = '#4ade80';
        else if(success === false) el.style.color = '#fbbf24';
        else el.style.color = 'white';
    }

    function renderResults() {
        document.getElementById('debugBox').style.display = 'none';
        document.getElementById('step2').classList.remove('hidden');
        const list = document.getElementById('resultsList');
        list.innerHTML = '';

        forms.forEach((f, idx) => {
            const div = document.createElement('div');
            div.className = 'form-row'; 
            div.onclick = () => openPreview(idx);
            div.innerHTML = `
                <div class="form-icon">${idx+1}</div>
                <div style="flex:1">
                    <input type="text" value="${f.name}" id="name-${idx}" onclick="event.stopPropagation()" style="width:100%; border:none; background:transparent; font-weight:bold; outline:none; font-size:1rem; color:var(--text);">
                    <div style="font-size:0.85rem; color:var(--text-dim); margin-top:4px;">Pages ${f.pages.join(', ')} ‚Ä¢ ${f.pages.length} page${f.pages.length>1?'s':''} ‚Ä¢ Click to preview</div>
                </div>`;
            list.appendChild(div);
        });
    }

    async function openPreview(formIdx) {
        currentPreviewForm = forms[formIdx];
        currentPreviewPage = 0;
        document.getElementById('previewModal').classList.add('active');
        await renderPreviewPage();
    }

    function closePreview() {
        document.getElementById('previewModal').classList.remove('active');
        currentPreviewForm = null;
    }

    async function previewPrevPage() {
        if (currentPreviewPage > 0) { currentPreviewPage--; await renderPreviewPage(); }
    }

    async function previewNextPage() {
        if (currentPreviewPage < currentPreviewForm.pages.length - 1) { currentPreviewPage++; await renderPreviewPage(); }
    }

    async function renderPreviewPage() {
        const pageNum = currentPreviewForm.pages[currentPreviewPage];
        document.getElementById('previewTitle').innerText = `Preview: ${currentPreviewForm.name}`;
        document.getElementById('previewInfo').innerText = `Viewing page ${currentPreviewPage + 1} of ${currentPreviewForm.pages.length} (PDF page ${pageNum})`;
        document.getElementById('pageIndicator').innerText = `${currentPreviewPage + 1} / ${currentPreviewForm.pages.length}`;
        document.getElementById('prevPageBtn').disabled = currentPreviewPage === 0;
        document.getElementById('nextPageBtn').disabled = currentPreviewPage === currentPreviewForm.pages.length - 1;

        const page = await pdfDocForPreview.getPage(pageNum);
        const scale = 1.5;
        const viewport = page.getViewport({ scale });
        const canvas = document.getElementById('previewCanvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const ctx = canvas.getContext('2d');
        await page.render({ canvasContext: ctx, viewport }).promise;
    }

    async function processDownloads() {
        const btn = document.getElementById('downloadBtn');
        btn.innerText = "‚è≥ Processing...";
        btn.disabled = true;
        
        const doctor = document.getElementById('doctorName').value.replace(/[^a-zA-Z0-9]/g, '_');
        const srcDoc = await PDFLib.PDFDocument.load(pdfBytes);

        for (let idx = 0; idx < forms.length; idx++) {
            const f = forms[idx];
            const finalName = document.getElementById(`name-${idx}`).value;
            const newDoc = await PDFLib.PDFDocument.create();
            const indices = f.pages.map(p => p - 1);
            const copied = await newDoc.copyPages(srcDoc, indices);
            copied.forEach(p => newDoc.addPage(p));
            
            const bytes = await newDoc.save();
            const blob = new Blob([bytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `Dr_${doctor}_${finalName.replace(/ /g, '_')}.pdf`;
            document.body.appendChild(a);
            a.click();
            
            await new Promise(r => setTimeout(r, 800));
        }
        btn.innerText = "‚úÖ Done!";
        setTimeout(() => { btn.disabled = false; btn.innerText = "‚¨áÔ∏è Download All Separated Files"; }, 3000);
    }
</script>
</body>
</html>
